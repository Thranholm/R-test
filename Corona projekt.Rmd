---
title: "Corona rapport"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, results="hide", warning=FALSE}

### Corona-monitorering Smittede ###

library(pacman)

pacman::p_load(lubridate, tidyverse, httr, jsonlite, stringr, ggplot2, 
               RColorBrewer, cowplot, zoo, directlabels, scales,
               ggmap, maps, mapdata, knitr)
#p_update()
rm(list = ls())


#### Specifik danmark data #####

# 
# start_dato <- dmy("09-03-2020")
# dage <- interval(start_dato, today())/days(1)
# datoer <- start_dato + days(0:dage)
# 
# indlagte <- c(6, 7, 10, NA, 23, NA, 28, 62, 82, 129, 153, 186, 206, 232, 254, 301,
#               350, 386, 430, 459, 499, 533, 52, 535, 525, 517, 507, 504)
# intensiv <- c(0, 0, 2, NA, 4, 4, 2, 10, 18, 24, 30, 37, 42, 46, 55, 69, 
#               87, 94, 109, 121, 131, 137, 145, 146, 153, 143, 142, 144)
# respirator <- c(NA, NA, NA, NA, NA, NA, NA, 2, 4, 18, 27, 32, 35, 40, 47, 58,
#                 76, 78, 89, 104, 113, 119, 131, 129, 138, 116, 112, 107)
# 
# regeringsindgreb <- c(0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
#                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
# 
# udvikling_dk <- data.frame(datoer, 
#                            indlagte, intensiv, respirator,
#                            regeringsindgreb
# )
# 
# View(udvikling_dk)



## Henter corona-tal for verden ####
corona <- GET("https://pomber.github.io/covid19/timeseries.json")
corona
corona_df <- as.data.frame(fromJSON(rawToChar(corona$content)))

## Fjerner datoen for alle lande, og gemmer kun ét datofelt
corona_df_tidy <- corona_df %>% 
  dplyr::mutate(date = Thailand.date) %>% 
  select(-contains(".date"))
# Ændre rækkefølgen i df, så dato-feltet er først.
corona_df_tidy <- corona_df_tidy[c(length(corona_df_tidy), 1:
                                     (length(corona_df_tidy)-1))]

## Laver til langt format og en masse rekodninger
corona_lang <- corona_df_tidy %>% 
  pivot_longer(cols = 2:length(corona_df_tidy),
               names_to = "land") %>% 
  dplyr::mutate(indc = land) %>% 
  dplyr::mutate(land = str_replace(land, c("confirmed", "deaths", "recovered"), "")) %>% 
  dplyr::mutate(land = str_replace_all(land, "\\.+", " ")) %>%
  dplyr::mutate(indc = str_match(indc, c("confirmed", "deaths", "recovered"))) %>% 
  pivot_wider(names_from = indc, values_from = value) %>% 
  dplyr::mutate(land=str_trim(land, side = "both")) %>% 
  arrange(-desc(land), -desc(date))

# Får dato-sortering rigtig.
corona_lang$date <-  as.Date(corona_lang$date, "%Y-%m-%d")
corona_lang <- arrange(corona_lang, -desc(land), -desc(date))
#View(corona_lang)

# Vil gerne koble verdensdele på
vd <- GET("https://pkgstore.datahub.io/JohnSnowLabs/country-and-continent-codes-list/country-and-continent-codes-list-csv_json/data/c218eebbf2f8545f3db9051ac893d69c/country-and-continent-codes-list-csv_json.json")
vd1 <- as.data.frame(fromJSON(rawToChar(vd$content)))
## Renser landenavn, fjerner alt efter komma
vd2 <- vd1 %>% 
  dplyr::mutate(Country_Name = str_replace(Country_Name, ", .*", "")) %>% 
  filter(!(Country_Name == "Turkey" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Russian Federation" & Continent_Name=="Asia")) %>% 
  filter(!(Country_Name == "Cyprus" & Continent_Name=="Asia")) %>% 
  filter(!(Country_Name == "Azerbaijan" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Armenia" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Georgia" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Kazakhstan" & Continent_Name=="Europe"))
#View(vd2)

## Joiner på
corona <- left_join(corona_lang, vd2, by = c("land" = "Country_Name"))

## Finder dem hvor vi ikke ramte, og koder manuelt. 18 styks
x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Continent_Name))
#View(x)

corona <- corona %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Brunei", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Burma", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cabo Verde", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Congo Brazzaville", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Congo Kinshasa", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cote d Ivoire", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Czechia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Eswatini", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Guinea Bissau", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Holy See", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Kosovo", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Korea South", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Kyrgyzstan", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Laos", "Asia", Continent_Name)) %>%
  dplyr::mutate(Continent_Name=if_else(land=="Libya", "Africa", Continent_Name)) %>%
  dplyr::mutate(Continent_Name=if_else(land=="North Macedonia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Russia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Slovakia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Syria", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Timor Leste", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="United Kingdom", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="US", "North America", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cruise Ship", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="West Bank and Gaza", "Asia", Continent_Name))
sum(is.na(corona$Continent_Name))



x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Country_Number))
#View(x)

corona <- corona %>% 
  dplyr::mutate(Country_Number=if_else(land=="Brunei",96, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Burma",104, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Cabo Verde",132,as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Congo Brazzaville", 178, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Congo Kinshasa", 180, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Cote d Ivoire", 384, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Czechia", 203, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Eswatini", 748, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Guinea Bissau", 624, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Holy See", 336, as.double(Country_Number))) %>% 
  #dplyr::mutate(Country_Number=if_else(land=="Kosovo", NA, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Korea South", 410, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Kyrgyzstan", 417, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Laos", 418, as.double(Country_Number))) %>%
  dplyr::mutate(Country_Number=if_else(land=="Libya", 434, as.double(Country_Number))) %>%
  dplyr::mutate(Country_Number=if_else(land=="North Macedonia", 807, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Russia", 643, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Slovakia",703, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Syria", 760, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Timor Leste", 626, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="United Kingdom", 826, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="US", 840, as.double(Country_Number)))


x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Continent_Name) | is.na(Country_Number))
#View(x)


### Kobler sub_regioner på
sub_reg <- GET("https://pkgstore.datahub.io/core/country-codes/country-codes_json/data/471a2e653140ecdd7243cdcacfd66608/country-codes_json.json")
sub_reg1 <- as.data.frame(fromJSON(rawToChar(sub_reg$content)))

sub_reg2 <- sub_reg1 %>% 
  select("Intermediate Region Name",
         "Languages", "M49", "Region Name", "Sub-region Name")

## ISO
ISO <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-iso-numeric.json")
ISO1 <- as.data.frame(fromJSON(rawToChar(ISO$content)))

## Kobler sub_regioner på:
region <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-region-in-world.json")
region1 <- as.data.frame(fromJSON(rawToChar(region$content)))

## Befolkningstal:
befolk <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-population.json")
befolk1 <- as.data.frame(fromJSON(rawToChar(befolk$content)))

## Befolkningstæthed
popu_dens <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-population-density.json")
popu_dens1 <- as.data.frame(fromJSON(rawToChar(popu_dens$content)))

koblet <- inner_join(ISO1, region1,
                     by = "country")
koblet <- inner_join(koblet, befolk1,
                     by = "country")
koblet <- inner_join(koblet, popu_dens1,
                     by = "country")


x <- koblet %>% 
  filter(is.na(iso))
#View(x)

koblet <- koblet %>% 
  dplyr::mutate(iso=if_else(country=="Congo",178,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Fiji Islands",242,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Holy See (Vatican City State)",336,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Kazakhstan",398,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Libyan Arab Jamahiriya",434,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Myanmar",104,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Russian Federation",643,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="SriLanka",144,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="The Democratic Republic of Congo",180,as.double(iso)))

koblet$iso <- as.numeric(koblet$iso)

koblet1 <- left_join(sub_reg2, koblet, by = c("M49" = "iso"))
#View(koblet1)

koblet1$country <- NULL

## Joiner verdensdele, regioner og befolkning på

corona <- left_join(corona, koblet1, by= c("Country_Number" = "M49"))

### Data er klar ###

#View(corona)

### Laver lags for at udregne stigning

corona <- corona %>% 
  group_by(Country_Number) %>% 
  mutate(udv_confirmed=confirmed-dplyr::lag(confirmed)) %>% 
  mutate(udv_deaths=deaths-dplyr::lag(deaths)) %>% 
  mutate(udv_recovered=recovered-dplyr::lag(recovered)) %>% 
  ## Laver datoer
  mutate(dagnr=day(date)) %>% 
  mutate(dag=wday(date)) %>% 
  mutate(ugedag=wday(date, label = TRUE, abbr = FALSE)) %>% 
  mutate(maanednr=month(date)) %>% 
  mutate(maaned=month(date, label = TRUE, abbr = FALSE)) %>% 
  mutate(ugenr=isoweek(date))


corona <- corona %>% 
  group_by(Country_Number) %>% 
  mutate(udv_confirmed=if_else(udv_confirmed<0,as.integer(0),udv_confirmed)) %>% 
  mutate(udv_deaths=if_else(udv_deaths<0,as.integer(0),udv_deaths)) %>% 
  ## Antal døde
  dplyr::mutate(days_3_death=cumsum(if_else(deaths>2,1,0))) %>% 
  dplyr::mutate(days_3_death=if_else(days_3_death==0,as.double(NA),
                                     days_3_death-1)) %>% 
  ## Antal smittede
  dplyr::mutate(days_3_case=cumsum(if_else(confirmed>2,1,0))) %>% 
  dplyr::mutate(days_3_case=if_else(days_3_case==0,as.double(NA),
                                    days_3_case-1)) %>% 
  ## Laver day case 200
  dplyr::mutate(days_1000_case=cumsum(if_else(confirmed>999,1,0))) %>% 
  dplyr::mutate(days_1000_case=if_else(days_1000_case==0,as.double(NA),
                                    days_1000_case-1)) %>% 
  ## Udregner rullende gennemsnit på antal smittet
  dplyr::mutate(roll_3_tot = rollmean(confirmed, k = 3, fill = NA, align = "right")) %>% 
  dplyr::mutate(roll_7_tot = rollmean(confirmed, k = 7, fill = NA, align = "right")) %>% 
  dplyr::mutate(ny_roll_3 = rollmean(udv_confirmed, k=3, fill = NA, align = "right")) %>% 
  dplyr::mutate(ny_roll_7 = rollmean(udv_confirmed, k=7, fill = NA, align = "right")) %>% 
  ## Forskel mellem
  dplyr::mutate(diff_roll_tot = roll_3_tot-roll_7_tot) %>% 
  dplyr::mutate(diff_roll_ny = ny_roll_3-ny_roll_7) %>% 
  ## Per capita udregninger
  mutate(per_cap100k_tot=(confirmed/population)*100000) %>% 
  mutate(per_cap100k=(udv_confirmed/population)*100000) %>% 
  mutate(per_cap_roll7=rollmean(per_cap100k, k=7, fill=NA, align = "right")) %>% 
  mutate(per_cap_roll14=rollmean(per_cap100k, k=14, fill = NA, align = "right")) %>% 
  mutate(ny_7=rollsum(udv_confirmed, k=7, fill = NA, align = "right")) %>% 
  mutate(rejse_vej=(rollmean(ny_7, k=14, fill=NA, align = "right")/population)*100000)


corona_nordic <- corona %>% 
  filter(location=="Nordic Countries" | land=="Czechia" | land=="Switzerland" |
           land=="Belgium" | land=="Netherlands") 
#%>% 
 # filter(!(land=="Iceland"))

big_ones <- corona %>% 
  filter(land=="United Kingdom" | land=="US" | land=="France" |
           land=="Italy" | land=="Spain" | land=="Germany" |
           land=="Brazil")
max(big_ones$date)
```

# Emils corona-blog

_Tallene viser de registerende tal per `r strftime(max(big_ones$date), "%d-%m-%Y")`_

*kilde: https://github.com/pomber/covid19*

Denne rapport følger udviklingen i corona-situationen på baggrund
af udvalgte tabeller med nøgletal og figurer. Det primære fokus i 
denne rapport på udviklingen i Europa.

*OBS: Danmarks tal er påvirket af at der i en periode har været inkluderet smittede for hurtig-test (ikke pcr-test), hvilket kan gøre at smitteudviklingen er lidt misvisende. Derudover kan der ske store udsving omkring påske grundet de mange helligdage. Tallene forventes at være normale igen torsdag den 8. april.*

*note: ikke alle kommentarer til tabeller er retvisende på nuværende tidspunkt, da koden er blevet opdateret for at forbedre tabel-layout og titler, mens teksten stadig mangler gennemgang*

## Udvikling i antal smittede
### Nøgletal
Denne tabel præsenterer antallet af smittede og vigtigere nye
smittefilfælde registret: `r strftime(max(big_ones$date), "%d-%m-%Y")`. I denne første tabel er fokus på de nordiske lande samt udvalge mindre europæiske land. Ønsker til tilføjelse af specifikke lande kan skrives til: [ethranholm@hotmail.com](mailto:ethranholm@hotmail.com).

##### Tabel 1: Nordiske og udvalgte europæiske lande smittetilfælde
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1 & 
           (location=="Nordic Countries" | land=="Czechia" | land=="Switzerland" |
              land=="Belgium" | land=="Netherlands" | land=="Austria")) %>% 
  select(land, confirmed, udv_confirmed, per_cap100k, per_cap_roll7) %>% 
  dplyr::arrange(desc(udv_confirmed)) %>% 
  top_n(7, udv_confirmed),
      format = "simple",
      row.names = TRUE,
      col.names = c("Land", "Total antal smittede", "Nye smittetilfælde", "Nye tilfælde per 100.000", "Nye tilfælde per 100.000, 7 dages rullende gennemsnit"),
      align = c("l", "r", "r", "r", "r"),
      digits = 1,
      format.args = list(big.mark = ".", scientific = FALSE,
                         decimal.mark = ",")
)
```


Confirmed er antallet af smittetilfælde i alt siden januar. Udv_confirmed er antallet af nye smittetilfælde `r strftime(max(big_ones$date), "%d-%m-%Y")`.

Følgende tabel viser de 15 lande med det højeste registrede nye smittetilfælde:

##### Tabel 2: Top 15 i verden smittetilfælde
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1) %>% 
  select(land, confirmed, udv_confirmed, per_cap100k, per_cap_roll7) %>% 
  dplyr::arrange(desc(udv_confirmed)) %>% 
  top_n(15, udv_confirmed) %>% 
  head(15),
      row.names = TRUE,
      col.names = c("Land", "Total antal smittede", "Nye smittetilfælde", "Nye tilfælde per 100.000", "Nye tilfælde per 100.000, 7 dages rullende gennemsnit"),
      align = c("l", "r", "r", "r", "r"),
      digits = 1,
      format.args = list(big.mark = ".", scientific = FALSE,
                         decimal.mark = ","),
      format = "simple"
)
```

Tabellen nedenfor viser udvikling i smittede for de lande, der er flest nye tilfælde per 100.000. Dog afgrænset til lande, hvor befolkningen er større end 1 mio.

##### Tabel 3: Top 15 i verden smittetilfælde per 100.000
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1 & population > 1*10**6) %>% 
  select(land, confirmed, udv_confirmed, per_cap100k, per_cap_roll7) %>% 
  dplyr::arrange(desc(per_cap100k)) %>% 
  top_n(15, per_cap100k) %>% 
  head(15),
    row.names = TRUE,
    col.names = c("Land", "Total antal smittede", "Nye smittetilfælde", "Nye tilfælde per 100.000", "Nye tilfælde per 100.000, 7 dages rullende gennemsnit"),
    align = c("l", "r", "r", "r", "r"),
    digits = 1,
    format.args = list(big.mark = ".", scientific = FALSE,
                        decimal.mark = ","),
    format = "simple"
  )
```


### Grafer og kort
Smitteudviklingen illustreres ved hjælp af flere grafer og kort nedenfor.

##### Figur 1: Graf over nye smittetilfælde nordisk lande og udvalgte europæiske lande, 7 dages rullende gennemsnit
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}
ggplot(corona_nordic, aes(x = days_3_case, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_brewer(palette = "Set1") +
  labs(title="Nordic rolling average 7 days new cases") +
  theme_light(base_size = 10) 
```


Vær opmærksom på at y-aksen af logaritme transformert. X-aksen viser antal dage siden 3 smittetilfælde.


##### Figur 2: Graf over nye tilfælde store lande, 7 dages rullende gennemsnit
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}
ggplot(big_ones, aes(x = days_3_case, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_brewer(palette = "Set1") +
  labs(title="Big 6 rolling average 7 days new cases") +
  theme_light()
```


Denne figur viser de store europæiske lande samt USA og Brasilien. Y-aksen er logaritme transformeret og x-aksen er dage siden 3 smittetilfælde


##### Figur 3: Graf over nye tilfælde lande med 10 flest nye tilfælde, 7 dages rullende gennemsnit
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}
top10_igår <- corona %>% 
  filter(date==today()-1) %>% 
  arrange(desc(udv_confirmed)) %>% 
  top_n(10, udv_confirmed) %>% 
  head(10) %>% 
  select(Country_Number)
top10 <- inner_join(top10_igår, corona, "Country_Number")



ggplot(top10, aes(x = days_3_case, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_brewer(palette = "Paired") +
  labs(title="Top 10 rolling average 7 days new cases") +
  theme_light()
```


Denne figur viser et 7 dages rullende gennemsnit af nye tilfælde for de 10 lande med flest nye smittetilfælde `r strftime(max(big_ones$date), "%d-%m-%Y")`.

#### Smitteudvikling i hele Europa
I følgende figur er y-aksen logaritme transformere, mens x-aksen er antal dage siden 1000 registrerede smittetilfælde

##### Figur 4: Hele Europa, 7 dages rullende gennemsnit
```{r echo=FALSE, warning=FALSE, fig.width=10, fig.asp=0.6}
europa <- corona %>% 
  filter(Continent_Name=="Europe") %>% 
  filter(!(land=="Cyprus" | land=="Kosovo"))


ggplot(europa, aes(x = days_1000_case, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_hue(h=c(0,360)+30, c=30, l=80, h.start = 0, direction = 1) +
  labs(title="Europe rolling average 7 days new cases, total") +
  theme_light() +
  geom_dl(aes(label = land), method = list("last.points", 
                                           cex = 0.5, rot=-35)) +
  theme(legend.position = "none")
```

Følgende figur er samme som ovenstående men med fokus på øverste højre hjørne.

##### Figur 5: Hele Europa fokuseret, 7 dages rullende gennemsnit

```{r echo=FALSE, warning=FALSE, fig.width=10, fig.asp=0.6}
ggplot(europa, aes(x = days_1000_case, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_hue(h=c(0,360)+30, c=30, l=80, h.start = 0, direction = 1) +
  labs(title="Europe rolling average 7 days new cases, focus") +
  theme_light() +
  geom_dl(aes(label = land), method = list("last.points", 
                                          cex = 0.5, rot=-35)) +
  theme(legend.position = "none") +
  coord_cartesian(xlim = c(max(europa$days_1000_case, na.rm = TRUE)-70,
                           max(europa$days_1000_case, na.rm = TRUE)+1),
                  ylim = c(50,45000))
```

### Den danske rejsevejledning
Danmarks rejsevejledninger bliver lavet på baggrund af en vurdering af smittetrykket i de enkelte lande (og om andre lande har restriktioner mod Danmark). Her fokuseres udelukkende på smittetrykket. Smittetrykket måles som antallet af smittede pr. 100.000 indbyggere per uge målt som gennemsnit over 14 dage. Er smittetrykket over 30 frarådes alle ikke-nødvendige rejser, mens landet "åbnes" igen ved et smittetryk på 20 eller under.

Følgende graf viser udviklingen i smittetrykket i de europæiske lande. Notér, at x-aksen er dage efter 1000 cases, mens y-aksen er logaritme transformeret. Den røde linje markerer et smittetryk på 30, som er den danske grænse for at der frarådes ikke-nødvendige rejser til landet. Mens den grønne linje ved smittetryk 20 markerer den grænse landet skal være under for at der igen åbnes for rejser.

I enkelte tilfælde er der lande, der nedjusterer antallet af smittede, således at antallet af nye smittede kan på dagen for nedjusteringen blive negativ. I disse tilfælde er der manuelt sat et 0 som antallet af nye smittede, da de negative nye smittede kan have ret stor påvirkning på tallene, der udregnes over længere tidsperioder. Et eksempel er Spanien, der 2. marts nedjusterede det samlede antal smittede med omkring 75.000.

##### Figur 6: Udvikling i smittetrykket i Europa, smittede per 100.000 per uge målt som gennemsnit over 14 dage

```{r echo=FALSE, warning=FALSE, fig.width=10, fig.asp=0.6}
ggplot(europa, aes(x = days_1000_case, y=rejse_vej)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_hue(h=c(0,360)+30, c=30, l=80, h.start = 0, direction = 1) +
  labs(title="Europe cases per 100.000 capita as average over 2 weeks, focus") +
  theme_light() +
  geom_dl(aes(label = land), method = list("last.points", 
                                           cex = 0.5, rot=-35)) +
  geom_hline(yintercept = c(20, 30), colour = c("green", "red"), 
             alpha=c(0.35,0.35), size=c(0.35,0.35)) +
  theme(legend.position = "none") +
  coord_cartesian(xlim = c(max(europa$days_1000_case, na.rm = TRUE)-70,
                           max(europa$days_1000_case, na.rm = TRUE)+1),
                  ylim = c(10,1000))
```



Følgende kort viser smittetrykket i de europæiske lande.

##### Kort 1: Smittetryk i Europa, smittede per 100.000 per uge målt som gennemsnit over 14 dage
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}

europa_lande <-  europa %>% 
  ungroup(Country_Number) %>% 
  filter(!(land=="Norway")) %>% 
  select(land)
europa_lande <- unique(europa_lande$land)
  

eu_geo <- map_data("world", region = c(europa_lande,
                                       "Czech Republic", "UK", "Macedonia", "Kosovo", "Turkey",
                                       "Norway(?!:Svalbard)", "Cyprus"))

eu_geo <- eu_geo %>% 
  filter(!(region=="Russia"))

til_geo <- corona %>% 
  group_by(Country_Number) %>% 
  mutate(rejse_vej_diff=rejse_vej-lag(rejse_vej, 7)) %>% 
  mutate(rejse_vej_diff1=rejse_vej-lag(rejse_vej, 1)) %>% 
  mutate(land=case_when(
    land=="Czechia" ~ "Czech Republic",
    land=="United Kingdom" ~ "UK",
    land=="North Macedonia" ~ "Macedonia",
    land=="Kosovo" ~ "Koso",
    TRUE ~ land
  )) %>% 
  filter(date == max(date))
  
eu_map_data <- left_join(eu_geo, til_geo, by = c("region" = "land"))

label_geo <- eu_map_data %>% 
  group_by(region) %>% 
  summarise(long=mean(long), lat=mean(lat),
            ny_roll_7=round(max(ny_roll_7),0),
            per_cap_roll7=round(max(per_cap_roll7),0),
            rejse_vej=round(max(rejse_vej),0),
            rejse_vej_diff=round(max(rejse_vej_diff),0),
            rejse_vej_diff1=round(max(rejse_vej_diff1),0),
            .groups = "drop_last"
            )

## Til at fjerne akser
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  legend.position = "none"
)

ggplot(eu_map_data, aes(x=long, y=lat)) +
  geom_polygon(aes(fill=rejse_vej, group=group), colour="white") + 
  coord_fixed(1.3) +
  geom_text(aes(label = rejse_vej), data=label_geo, size=3) +
  scale_fill_gradient2(low = "green", mid = "yellow", high = "red", midpoint = log10(30), trans="log10") + 
  #scale_fill_gradientn(colours=c("green", "yellow", "red"), breaks = c(20,30), trans="log10") +
  #scale_fill_gradient(low = "green", high = "red", trans ="log10") +
  theme_bw() +
  labs(title = "Smittede per 100.000 som gennemsnit over 14 dage") +
  ditch_the_axes
```


Nedenstående kort viser udviklingen i smittetrykket. Tallene er forskellen mellem det nuværende smittetryk og smittetrykket for en uge siden. Derfor kan det en indikation om smitten stiger eller falder og med hvilken hastighed. Tal over 0 betyder en stigende smitte, tal under 0 er en aftagende smitte. Dette siger dog ikke noget om det totale smitteniveau, eksempelvis kan man godt have aftagende smitte, men stadig et højt smittetryk. Det kort kan mere bruges til vurdere og det går i en positiv eller negativ retning.

##### Kort 2: udvikling i smittetryk, 7 dage siden
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}
ggplot(eu_map_data, aes(x=long, y=lat)) +
  geom_polygon(aes(fill=rejse_vej_diff, group=group), colour="white") + 
  coord_fixed(1.3) +
  geom_text(aes(label = rejse_vej_diff), data=label_geo, size=3) +
  scale_fill_gradient2(low = "green", mid = c("green", "yellow", "red"), high = "red", midpoint = 10) +
  theme_bw() +
  labs(title = "Udvikling i smittetryk sammenlignet med en uge siden") +
  ditch_the_axes
```

Nedenstående kort viser udviklingen i smittetrykket sammenlignet med i går. Her skal man dog være opmærksom på, at denne kan være mere følsom overfor registreringer end kort 2 ovenfor, hvor der sammenlignes med smittetrykket for en uge siden. Helt konkret er der nogle lande, hvor der ikke registreres antal smittetilfælde i weekenderne, men offentliggøre så tal for hele weekenden mandag eller tirsdag, det kan få nogle lande til at slå mere ud på bestemte dage (Sverige registrerer på nuværende tidspunkt ikke nye smittede i weekenderne, men først samlet mandag eller tirsdag). Dog med de forbehold kan dette kort give en indikation på, hvor hurtigt smitten er stigende eller aftagende.

##### Kort 3: Udvikling i smittetryk sammenlignet med i går
```{r warning=FALSE, echo=FALSE, fig.width=10, fig.asp=0.6}
ggplot(eu_map_data, aes(x=long, y=lat)) +
  geom_polygon(aes(fill=rejse_vej_diff1, group=group), colour="white") + 
  coord_fixed(1.3) +
  geom_text(aes(label = rejse_vej_diff1), data=label_geo, size=3) +
  scale_fill_gradient2(low = "green", mid = c("green", "yellow", "red"), high = "red", midpoint = 10) +
  theme_bw() +
  labs(title = "Udvikling i smittetryk sammenlignet med i går") +
  ditch_the_axes
```


# Udvikling i dødsfald

```{r warning=FALSE, echo=FALSE, results="hide"}
### Corona-monitorering ###

library(pacman)

pacman::p_load(lubridate, tidyverse, httr, jsonlite, stringr, ggplot2, 
               RColorBrewer, cowplot, zoo, dplyr, knitr)
#p_update()
rm(list = ls())


#### Specifik danmark data #####

# 
# start_dato <- dmy("09-03-2020")
# dage <- interval(start_dato, today())/days(1)
# datoer <- start_dato + days(0:dage)
# 
# indlagte <- c(6, 7, 10, NA, 23, NA, 28, 62, 82, 129, 153, 186, 206, 232, 254, 301,
#               350, 386, 430, 459, 499, 533, 52, 535, 525, 517, 507, 504)
# intensiv <- c(0, 0, 2, NA, 4, 4, 2, 10, 18, 24, 30, 37, 42, 46, 55, 69, 
#               87, 94, 109, 121, 131, 137, 145, 146, 153, 143, 142, 144)
# respirator <- c(NA, NA, NA, NA, NA, NA, NA, 2, 4, 18, 27, 32, 35, 40, 47, 58,
#                 76, 78, 89, 104, 113, 119, 131, 129, 138, 116, 112, 107)
# 
# regeringsindgreb <- c(0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
#                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
# 
# udvikling_dk <- data.frame(datoer, 
#                            indlagte, intensiv, respirator,
#                            regeringsindgreb
# )
# 
# View(udvikling_dk)



## Henter corona-tal for verden ####
corona <- GET("https://pomber.github.io/covid19/timeseries.json")
corona
corona_df <- as.data.frame(fromJSON(rawToChar(corona$content)))
head(corona_df)

## Fjerner datoen for alle lande, og gemmer kun ét datofelt
corona_df_tidy <- corona_df %>% 
  dplyr::mutate(date = Thailand.date) %>% 
  select(-contains(".date"))
# Ændre rækkefølgen i df, så dato-feltet er først.
corona_df_tidy <- corona_df_tidy[c(length(corona_df_tidy), 1:
                                     (length(corona_df_tidy)-1))]

## Laver til langt format og en masse rekodninger
corona_lang <- corona_df_tidy %>% 
  tidyr::pivot_longer(cols = 2:length(corona_df_tidy),
               names_to = "land") %>% 
  dplyr::mutate(indc = land) %>% 
  dplyr::mutate(land = str_replace(land, c("confirmed", "deaths", "recovered"), "")) %>% 
  dplyr::mutate(land = str_replace_all(land, "\\.+", " ")) %>%
  dplyr::mutate(indc = str_match(indc, c("confirmed", "deaths", "recovered"))) %>% 
  tidyr::pivot_wider(names_from = indc, values_from = value) %>% 
  dplyr::mutate(land=str_trim(land, side = "both")) %>% 
  arrange(-desc(land), -desc(date))

# Får dato-sortering rigtig.
corona_lang$date <-  as.Date(corona_lang$date, "%Y-%m-%d")
corona_lang <- arrange(corona_lang, -desc(land), -desc(date))
#View(corona_lang)

# Vil gerne koble verdensdele på
vd <- GET("https://pkgstore.datahub.io/JohnSnowLabs/country-and-continent-codes-list/country-and-continent-codes-list-csv_json/data/c218eebbf2f8545f3db9051ac893d69c/country-and-continent-codes-list-csv_json.json")
vd1 <- as.data.frame(fromJSON(rawToChar(vd$content)))
## Renser landenavn, fjerner alt efter komma
vd2 <- vd1 %>% 
  dplyr::mutate(Country_Name = str_replace(Country_Name, ", .*", "")) %>% 
  filter(!(Country_Name == "Turkey" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Russian Federation" & Continent_Name=="Asia")) %>% 
  filter(!(Country_Name == "Cyprus" & Continent_Name=="Asia")) %>% 
  filter(!(Country_Name == "Azerbaijan" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Armenia" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Georgia" & Continent_Name=="Europe")) %>% 
  filter(!(Country_Name == "Kazakhstan" & Continent_Name=="Europe"))
#View(vd2)

## Joiner på
corona <- left_join(corona_lang, vd2, by = c("land" = "Country_Name"))

## Finder dem hvor vi ikke ramte, og koder manuelt. 18 styks
x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Continent_Name))
#View(x)

corona <- corona %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Brunei", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Burma", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cabo Verde", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Congo Brazzaville", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Congo Kinshasa", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cote d Ivoire", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Czechia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Eswatini", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Guinea Bissau", "Africa", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Holy See", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Kosovo", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Korea South", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Kyrgyzstan", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Laos", "Asia", Continent_Name)) %>%
  dplyr::mutate(Continent_Name=if_else(land=="Libya", "Africa", Continent_Name)) %>%
  dplyr::mutate(Continent_Name=if_else(land=="North Macedonia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Russia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Slovakia", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Syria", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Timor Leste", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="United Kingdom", "Europe", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="US", "North America", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="Cruise Ship", "Asia", Continent_Name)) %>% 
  dplyr::mutate(Continent_Name=if_else(land=="West Bank and Gaza", "Asia", Continent_Name))
sum(is.na(corona$Continent_Name))



x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Country_Number))
#View(x)

corona <- corona %>% 
  dplyr::mutate(Country_Number=if_else(land=="Brunei",96, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Burma",104, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Cabo Verde",132,as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Congo Brazzaville", 178, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Congo Kinshasa", 180, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Cote d Ivoire", 384, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Czechia", 203, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Eswatini", 748, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Guinea Bissau", 624, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Holy See", 336, as.double(Country_Number))) %>% 
  #dplyr::mutate(Country_Number=if_else(land=="Kosovo", NA, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Korea South", 410, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Kyrgyzstan", 417, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Laos", 418, as.double(Country_Number))) %>%
  dplyr::mutate(Country_Number=if_else(land=="Libya", 434, as.double(Country_Number))) %>%
  dplyr::mutate(Country_Number=if_else(land=="North Macedonia", 807, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Russia", 643, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Slovakia",703, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Syria", 760, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="Timor Leste", 626, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="United Kingdom", 826, as.double(Country_Number))) %>% 
  dplyr::mutate(Country_Number=if_else(land=="US", 840, as.double(Country_Number)))


x <- corona %>% 
  group_by(land) %>% 
  filter(row_number(land)==1) %>% 
  filter(is.na(Continent_Name) | is.na(Country_Number))
#View(x)


### Kobler sub_regioner på
sub_reg <- GET("https://pkgstore.datahub.io/core/country-codes/country-codes_json/data/471a2e653140ecdd7243cdcacfd66608/country-codes_json.json")
sub_reg1 <- as.data.frame(fromJSON(rawToChar(sub_reg$content)))

sub_reg2 <- sub_reg1 %>% 
  select("Intermediate Region Name",
         "Languages", "M49", "Region Name", "Sub-region Name")

## ISO
ISO <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-iso-numeric.json")
ISO1 <- as.data.frame(fromJSON(rawToChar(ISO$content)))

## Kobler sub_regioner på:
region <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-region-in-world.json")
region1 <- as.data.frame(fromJSON(rawToChar(region$content)))

## Befolkningstal:
befolk <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-population.json")
befolk1 <- as.data.frame(fromJSON(rawToChar(befolk$content)))

## Befolkningstæthed
popu_dens <- GET("https://raw.githubusercontent.com/samayo/country-json/master/src/country-by-population-density.json")
popu_dens1 <- as.data.frame(fromJSON(rawToChar(popu_dens$content)))

koblet <- inner_join(ISO1, region1,
                     by = "country")
koblet <- inner_join(koblet, befolk1,
                     by = "country")
koblet <- inner_join(koblet, popu_dens1,
                     by = "country")


x <- koblet %>% 
  filter(is.na(iso))
#View(x)

koblet <- koblet %>% 
  dplyr::mutate(iso=if_else(country=="Congo",178,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Fiji Islands",242,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Holy See (Vatican City State)",336,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Kazakhstan",398,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Libyan Arab Jamahiriya",434,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Myanmar",104,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="Russian Federation",643,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="SriLanka",144,as.double(iso))) %>% 
  dplyr::mutate(iso=if_else(country=="The Democratic Republic of Congo",180,as.double(iso)))

koblet$iso <- as.numeric(koblet$iso)

koblet1 <- left_join(sub_reg2, koblet, by = c("M49" = "iso"))
#View(koblet1)

koblet1$country <- NULL

## Joiner verdensdele, regioner og befolkning på

corona <- left_join(corona, koblet1, by= c("Country_Number" = "M49"))

### Data er klar ###

#View(corona)

### Laver lags for at udregne stigning

corona <- corona %>% 
  group_by(Country_Number) %>% 
  mutate(udv_confirmed=confirmed-dplyr::lag(confirmed)) %>% 
  mutate(udv_deaths=deaths-dplyr::lag(deaths)) %>% 
  mutate(udv_recovered=recovered-dplyr::lag(recovered)) %>% 
  ## Laver datoer
  mutate(dagnr=day(date)) %>% 
  mutate(dag=wday(date)) %>% 
  mutate(ugedag=wday(date, label = TRUE, abbr = FALSE)) %>% 
  mutate(maanednr=month(date)) %>% 
  mutate(maaned=month(date, label = TRUE, abbr = FALSE)) %>% 
  mutate(ugenr=isoweek(date))


corona <- corona %>% 
  group_by(Country_Number) %>% 
  ## Antal døde
  dplyr::mutate(days_3_death=cumsum(if_else(deaths>2,1,0))) %>% 
  dplyr::mutate(days_3_death=if_else(days_3_death==0,as.double(NA),
                                  days_3_death-1)) %>% 
  ## Antal smittede
  dplyr::mutate(days_3_case=cumsum(if_else(confirmed>2,1,0))) %>% 
  dplyr::mutate(days_3_case=if_else(days_3_case==0,as.double(NA),
                                        days_3_case-1)) %>% 
  ## Udregner rullende gennemsnit på antal afgået
  dplyr::mutate(roll_3_tot = rollmean(deaths, k = 3, fill = NA, align = "right")) %>% 
  dplyr::mutate(roll_7_tot = rollmean(deaths, k = 7, fill = NA, align = "right")) %>% 
  dplyr::mutate(ny_roll_3 = rollmean(udv_deaths, k=3, fill = NA, align = "right")) %>% 
  dplyr::mutate(ny_roll_7 = rollmean(udv_deaths, k=7, fill = NA, align = "right")) %>% 
  ## Forskel mellem
  dplyr::mutate(diff_roll_tot = roll_3_tot-roll_7_tot) %>% 
  dplyr::mutate(diff_roll_ny = ny_roll_3-ny_roll_7) %>% 
  ## Kigger på per capita
  mutate(per_cap100k_tot=(deaths/population)*100000)



corona_nordic <- corona %>% 
  filter(location=="Nordic Countries" | land=="Czechia" | land=="Switzerland" |
           land=="Belgium" | land=="Netherlands") %>% 
  filter(!(land=="Iceland"))

big_ones <- corona %>% 
  filter(land=="United Kingdom" | land=="US" | land=="France" |
           land=="Italy" | land=="Spain" | land=="Germany" |
           land=="Brazil")
strftime(max(big_ones$date), "%d-%m-%Y")
```

Nedenstående tabel viser udvikling i dødsfald i udv_deaths `r strftime(max(big_ones$date), "%d-%m-%Y")` og total antal dødsfald i deaths. Første tabel viser det for udvalgte mindre Europæiske lande, mens det efterfølgende viser på verdensplan.

##### Tabel 4: Udvikling i dødsfald udvalgte europæiske lande
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1 & 
           (location=="Nordic Countries" | land=="Czechia" | land=="Switzerland" |
              land=="Belgium" | land=="Netherlands" | land=="Austria")) %>% 
  select(land, deaths, udv_deaths, ny_roll_7) %>% 
  dplyr::arrange(desc(udv_deaths)) %>% 
  top_n(7, udv_deaths),
  row.names = TRUE,
  col.names = c("Land", "Total antal dødsfald", "Nye dødsfald", "Nye dødsfald, 7 dages rullende gennemsnit"),
  align = c("l", "r", "r", "r"),
  digits = 1,
  format.args = list(big.mark = ".", scientific = FALSE,
                         decimal.mark = ","),
  format = "simple"
)
```

##### Tabel 5: Udvikling i dødsfald, flest nye dødsfald verdensplan
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1) %>% 
  select(land, deaths, udv_deaths,  ny_roll_7) %>% 
  dplyr::arrange(desc(udv_deaths)) %>% 
  top_n(15, udv_deaths) %>% 
  head(15),
  row.names = TRUE,
  col.names = c("Land", "Total antal dødsfald", "Nye dødsfald", "Nye dødsfald, 7 dages rullende gennemsnit"),
  align = c("l", "r", "r", "r"),
  digits = 1,
  format.args = list(big.mark = ".", scientific = FALSE,
                         decimal.mark = ","),
  format = "simple"
)
```


Figurerne nedenfor viser nye dødsfald som rullende 7-dages gennemsnit. X-aksen er antal dage siden 3 dødsfald og y-aksen er logaritme transformeret.

##### Figur 6: Udvikling nye dødsfald udvalgte europæiske lande, 7-dages rullende gennemsnit
```{r echo=FALSE, warning=FALSE, fig.width=10, fig.asp=0.6}
ggplot(corona_nordic, aes(x = days_3_death, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_brewer(palette = "Set1") +
  labs(title="Nordic rolling average 7 days new cases") +
  theme_light()
```

##### Figur 7: Udvikling nye dødsfald udvalgte store lande, 7-dages rullende gennemsnit
```{r echo=FALSE, warning=FALSE, fig.width=10, fig.asp=0.6}
ggplot(big_ones, aes(x = days_3_death, y=ny_roll_7)) +
  geom_line(aes(colour = land)) +
  scale_y_log10() +
  scale_colour_brewer(palette = "Set1") +
  labs(title="Big 6 rolling average 7 days new cases") +
  theme_light()
```


Følgende tabel er sorteret efter antal dødsfald per 100.000 indbyggere

##### Tabel 6: Dødsfald per 100.000 indbyggere
```{r echo=FALSE}
kable(corona %>% 
  group_by(land) %>% 
  filter(date==today()-1) %>% 
  ## fjerner lande, der ligger dobbelt
  filter(!(land=="Kosovo" | land=="West Bank and Gaza" | land=="Diamond Princess" |
            land=="MS Zaandam")) %>% 
  select(land, deaths, udv_deaths, per_cap100k_tot) %>% 
  dplyr::arrange(desc(per_cap100k_tot)) %>% 
  top_n(30, per_cap100k_tot) %>% 
  head(30),
  row.names = TRUE,
  col.names = c("Land", "Total dødsfald", "Nye dødsfald", "Dødsfald per 100.000"),
  align = c("l", "r", "r", "r"),
  digits = 1,
  format.args = list(big.mark = ".", scientific = FALSE,
                         decimal.mark = ","),
  format = "simple"
)
```


*af: Emil Thranholm, mail: [ethranholm@hotmail.com](mailto:ethranholm@hotmail.com)*

